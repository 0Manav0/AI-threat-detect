{% extends "base.html" %}
{% block title %}Index{% endblock %}

{% block content %}
<h2>Threat Prediction</h2>
<form id="predictForm">
    {% for col in feature_columns %}
        <label>{{ col.replace('_', ' ').title() }}:</label>
        <input type="number" name="{{ col }}" value="0" step="any"><br>
    {% endfor %}
    <button type="submit">Predict</button>
</form>
<div id="result"></div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('predictForm').addEventListener('submit', async function(e){
    e.preventDefault();
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
        data[key] = parseFloat(value) || 0;
    });

    const response = await fetch("/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });

    const result = await response.json();
    const resultDiv = document.getElementById('result');

    if(result.error){
        resultDiv.textContent = "Error: " + result.error;
        resultDiv.className = "";
    } else {
        // Prediction result
        const pred = result.prediction[0];
        const conf = result.confidence[0];
        resultDiv.innerHTML = `
            <p>Prediction: ${pred === 1 ? 'Threat' : 'Safe'}</p>
            <p>Confidence: ${conf}</p>
            <p>Issues:</p>
            <ul>${result.issues.map(i => `<li>${i}</li>`).join('')}</ul>
        `;
        resultDiv.className = pred === 1 && conf > 0.55 ? 'declined' : 'accepted';
    }
});
</script>
{% endblock %}
